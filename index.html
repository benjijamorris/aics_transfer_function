

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Welcome to AICS Transfer Function’s documentation! &mdash; AICS Transfer Function 0.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="#" class="icon icon-home"> AICS Transfer Function
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#stable-release">Stable release</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#from-sources">From sources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Package modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="aics_transfer_function.html">aics_transfer_function package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="aics_transfer_function.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="aics_transfer_function.bin.html">aics_transfer_function.bin package</a></li>
<li class="toctree-l4"><a class="reference internal" href="aics_transfer_function.dataloader.html">aics_transfer_function.dataloader package</a></li>
<li class="toctree-l4"><a class="reference internal" href="aics_transfer_function.models.html">aics_transfer_function.models package</a></li>
<li class="toctree-l4"><a class="reference internal" href="aics_transfer_function.options.html">aics_transfer_function.options package</a></li>
<li class="toctree-l4"><a class="reference internal" href="aics_transfer_function.util.html">aics_transfer_function.util package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="aics_transfer_function.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="aics_transfer_function.html#aics-transfer-function-proj-tester-module">aics_transfer_function.proj_tester module</a></li>
<li class="toctree-l3"><a class="reference internal" href="aics_transfer_function.html#aics-transfer-function-proj-trainer-module">aics_transfer_function.proj_trainer module</a></li>
<li class="toctree-l3"><a class="reference internal" href="aics_transfer_function.html#module-aics_transfer_function">Module contents</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#get-started">Get Started!</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#deploying">Deploying</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="math.html">Math notation example</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">AICS Transfer Function</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="#" class="icon icon-home"></a> &raquo;</li>
        
      <li>Welcome to AICS Transfer Function’s documentation!</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="installation.html" class="btn btn-neutral float-right" title="Installation" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
      
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="welcome-to-aics-transfer-function-s-documentation">
<h1>Welcome to AICS Transfer Function’s documentation!<a class="headerlink" href="#welcome-to-aics-transfer-function-s-documentation" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
</div>
<div class="section" id="aics-transfer-function">
<h1>AICS Transfer Function<a class="headerlink" href="#aics-transfer-function" title="Permalink to this headline">¶</a></h1>
<a class="reference external image-reference" href="https://github.com/AllenCell/aics_transfer_function/actions"><img alt="Build Status" src="https://github.com/AllenCell/aics_transfer_function/workflows/Build%20Master/badge.svg" /></a>
<a class="reference external image-reference" href="https://AllenCell.github.io/aics_transfer_function"><img alt="Documentation" src="https://github.com/AllenCell/aics_transfer_function/workflows/Documentation/badge.svg" /></a>
<a class="reference external image-reference" href="https://codecov.io/gh/AllenCell/aics_transfer_function"><img alt="Code Coverage" src="https://codecov.io/gh/AllenCell/aics_transfer_function/branch/main/graph/badge.svg" /></a>
<p>Python package for building 3d computational transfer function models for light microscopy images</p>
<hr class="docutils" />
<div class="section" id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h2>
<p>To build a transfer function from a source domain (e.g., low resolution images) to a target domain (e.g., high resolution images), we assume the training data (pairs of images in both source and target domains) are prepared by the registration step (see: <a class="reference external" href="https://github.com/AllenCell/aics_tf_registration">https://github.com/AllenCell/aics_tf_registration</a>). After that, there are three main steps: (1) calculating intensity normalization parameters. (2) training , (3) testing</p>
<ol class="arabic simple">
<li><p>intensity normalization parameter</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python scripts/pre_process_calc.py --source_domain /path/to/source/domain/data --target_domain /path/to/target/domain/data
</pre></div>
</div>
<p>parameters will be printed out on command line screen.</p>
<ol class="arabic simple" start="2">
<li><p>training</p></li>
</ol>
<p>Take the intensity normalization parameters calculated in step 1 and prepare a training configuration file (<a class="reference external" href="https://github.com/AllenCell/aics_transfer_function/blob/main/aics_transfer_function/config/transfer_function_training_example.yaml">Example</a>). Mostly, just updating the normalization parameters, data paths, model save path, experiment names, etc. Then</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>TF_run --config /path/to/training/config.yaml --model train
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>testing</p></li>
</ol>
<p>The testing step can be done in three different ways:</p>
<ul class="simple">
<li><p>validation: both source domain images and target domain images (ground truth) are available. This can be used to validate the model performance. <a class="reference external" href="https://github.com/AllenCell/aics_transfer_function/blob/main/aics_transfer_function/config/transfer_function_validation_example.yaml">Example configuration file</a> Then, <code class="docutils literal notranslate"><span class="pre">TF_run</span> <span class="pre">--config</span> <span class="pre">/path/to/validation/config.yaml</span> <span class="pre">--model</span> <span class="pre">validation</span></code></p></li>
<li><p>inference: only source domain images are available. This is used to make predictions on new data. <a class="reference external" href="https://github.com/AllenCell/aics_transfer_function/blob/main/aics_transfer_function/config/transfer_function_inference_example.yaml">Exmaple configuration file</a>. Then, <code class="docutils literal notranslate"><span class="pre">TF_run</span> <span class="pre">--config</span> <span class="pre">/path/to/inference/config.yaml</span> <span class="pre">--model</span> <span class="pre">inference</span></code></p></li>
<li><p>API for applying transfer function on numpy array: This is useful when you want to use transfer function as part of your big workflow. <a class="reference external" href="https://github.com/AllenCell/aics_transfer_function/blob/main/playbook/apply_tf_on_numpy_array.ipynb">Demo Jupyter Notebook</a></p></li>
</ul>
<p><strong>Note about parameters in configuration yaml file</strong>
In general, only the <code class="docutils literal notranslate"><span class="pre">datapath</span></code> and <code class="docutils literal notranslate"><span class="pre">normalization</span></code> sections need to change, no matter for training or testing.
<em>``datapath``: the directory of source domain images and target domain images (no target when doing inference), as well as the directory to save prediction (only when testing)</em><code class="docutils literal notranslate"><span class="pre">normalization</span></code>: Only <code class="docutils literal notranslate"><span class="pre">simple_norm</span></code> using <code class="docutils literal notranslate"><span class="pre">middle_otsu</span></code> is supported currently. <code class="docutils literal notranslate"><span class="pre">simple_norm</span></code> refers intensity normalization by rescaling the intensity into <code class="docutils literal notranslate"><span class="pre">[m</span> <span class="pre">-</span> <span class="pre">a</span> <span class="pre">*</span> <span class="pre">s,</span> <span class="pre">m</span> <span class="pre">+</span> <span class="pre">b</span> <span class="pre">*</span> <span class="pre">s]</span></code>, where <code class="docutils literal notranslate"><span class="pre">m</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code> are mean intensity and standard deviation of all “valid” voxels. Here, “valid” voxels are the middle chunk of the image stack, where the middle chunk is estimated by applying Otsu thresholding to roughly identify where the signals are. By doing this, we could reduce the impact of empty z-slices near the bottom and top of the stack. This is also where the name <code class="docutils literal notranslate"><span class="pre">middle_otsu</span></code> comes from.</p>
<p>Besides above two, there one section (called <code class="docutils literal notranslate"><span class="pre">save</span></code>) specific to training. Users can specify where to save the model (<code class="docutils literal notranslate"><span class="pre">results_folder</span></code>) and whether to save example predictions periodically (<code class="docutils literal notranslate"><span class="pre">save_training_inspections</span></code>), if so, how frequent to save (<code class="docutils literal notranslate"><span class="pre">print_freq</span></code>). Also, it is recommeded to set <code class="docutils literal notranslate"><span class="pre">save_latest_freq</span></code> (how frequent to save the model) the same as <code class="docutils literal notranslate"><span class="pre">print_freq</span></code>, so that the example prediction you observe matches the checkpoints being saved.</p>
<p>One last important parameter is <code class="docutils literal notranslate"><span class="pre">path</span></code> under <code class="docutils literal notranslate"><span class="pre">load_trained_model</span></code> section. If this is used in training, it means the training will use this model as the initial model. If this is used in testing, it is the path to the model you want to apply.</p>
<ol class="arabic simple" start="4">
<li><p>Auto-Alignment module</p></li>
</ol>
<p>The Auto-Alignment (AA) module is an optional training step designed to improve the model performance when we know the training pairs are prone to mis-alignment. To use the AA module, we assume a regular trianing, see section (2) above, has finished and the trained model is saved at <code class="docutils literal notranslate"><span class="pre">/path/to/basic/model</span></code>. The AA module has two stages: estimating mis-alignment, and fine-tuning the model after adjusting the training data with estimated mis-alignment.</p>
<p>Stage 1: Update the configuration file (<a class="reference external" href="https://github.com/AllenCell/aics_transfer_function/blob/main/aics_transfer_function/config/auto-alignment.yaml">exmaple</a>), especially setting <code class="docutils literal notranslate"><span class="pre">path</span></code> (under <code class="docutils literal notranslate"><span class="pre">load_trained_model</span></code>) as <code class="docutils literal notranslate"><span class="pre">/path/to/basic/model</span></code> (i.e., the model trained with regular steps) and using the same normalization parameters, data paths, model saving path as when training the basic model. Notice that <code class="docutils literal notranslate"><span class="pre">model</span></code> becomes <code class="docutils literal notranslate"><span class="pre">stn</span></code>, instead of <code class="docutils literal notranslate"><span class="pre">pix2pix</span></code> and there are also more parameters comparing to regular training. In most cases, these new settings do not need to change. Then, <code class="docutils literal notranslate"><span class="pre">TF_run</span> <span class="pre">--model</span> <span class="pre">train</span> <span class="pre">--config</span> <span class="pre">/path/to/new/AA/config_stage_1.yaml</span></code> After training, a new file <code class="docutils literal notranslate"><span class="pre">offset.log</span></code> will be generated in the <code class="docutils literal notranslate"><span class="pre">results_folder</span></code>.</p>
<p>Stage 2: Update the configuration file (<a class="reference external" href="https://github.com/AllenCell/aics_transfer_function/blob/main/aics_transfer_function/config/auto-alignment_stage_2.yaml">exmaple</a>), especially setting <code class="docutils literal notranslate"><span class="pre">path</span></code> (under <code class="docutils literal notranslate"><span class="pre">load_trained_model</span></code>) as <code class="docutils literal notranslate"><span class="pre">/path/to/stage_1/model</span></code> (i.e., the model from previous training stage), and setting the new parameter <code class="docutils literal notranslate"><span class="pre">readoffsetfrom</span></code> as <code class="docutils literal notranslate"><span class="pre">/path/to/stage_1/offset.log</span></code>, and using the same normalization parameters, data paths, model saving path as before. In most cases, other settings do not need to change. Then, <code class="docutils literal notranslate"><span class="pre">TF_run</span> <span class="pre">--model</span> <span class="pre">train</span> <span class="pre">--config</span> <span class="pre">/path/to/new/AA/config_stage_2.yaml</span></code> After training, the new model in <code class="docutils literal notranslate"><span class="pre">results_folder</span></code> can be used for inference.</p>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p><strong>Stable Release:</strong> <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">aics_transfer_function</span></code><span class="raw-html-m2r"><br></span>
<strong>Development Head:</strong> <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">git+https://github.com/AllenCell/aics_transfer_function.git</span></code></p>
</div>
<div class="section" id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h2>
<p>For full package documentation please visit <a class="reference external" href="https://AllenCell.github.io/aics_transfer_function">AllenCell.github.io/aics_transfer_function</a>.</p>
</div>
<div class="section" id="development">
<h2>Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference external" href="CONTRIBUTING.md">CONTRIBUTING.md</a> for information related to developing the code.</p>
<p>The implementation of this repo was partially inspired by <a class="reference external" href="https://github.com/junyanz/pytorch-CycleGAN-and-pix2pix">https://github.com/junyanz/pytorch-CycleGAN-and-pix2pix</a>. A few core functions were reused.</p>
<p><a href="#id2"><span class="problematic" id="id3">**</span></a><em>Free software: Allen Institute Software License</em>**</p>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Jianxu Chen.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>